version: 2

models:
  - name: dim_accounts_enhanced
    config:
      contract:
        enforced: true
    constraints:
      - type: primary_key
        columns: [account_key]
      - type: check
        expression: "account_category IN ('Asset', 'Liability', 'Unknown')"
        name: chk_account_category_valid
      - type: check
        expression: "currency_code IN ('AUD', 'USD', 'EUR', 'GBP')"
        name: chk_currency_code_valid
      - type: check
        expression: "total_transactions >= 0"
        name: chk_total_transactions_non_negative
    columns:
      - name: account_key
        data_type: text
        description: "Surrogate key for the account dimension"
      - name: account_name
        data_type: text
        description: "Name of the account"
      - name: bank_name
        data_type: text  
        description: "Bank that manages the account"
      - name: account_type
        data_type: text
        description: "Type of account (Home Loan, Offset, etc.)"
      - name: account_category
        data_type: text
        description: "Category of account (Asset, Liability)"
      - name: level_1_bank
        data_type: text
        description: "Level 1 of account hierarchy - bank name"
      - name: level_2_category
        data_type: text
        description: "Level 2 of account hierarchy - account category"
      - name: level_3_type
        data_type: text
        description: "Level 3 of account hierarchy - account type"
      - name: level_4_account
        data_type: text
        description: "Level 4 of account hierarchy - account name"
      - name: account_start_date
        data_type: date
        description: "Date of first transaction for this account"
      - name: account_last_transaction_date
        data_type: date
        description: "Date of most recent transaction"
      - name: total_transactions
        data_type: bigint
        description: "Total number of transactions for this account"
      - name: currency_code
        data_type: text
        description: "Currency code for the account"
      - name: is_active
        data_type: boolean
        description: "Whether the account is currently active"
      - name: is_liability
        data_type: boolean
        description: "Whether this account represents a liability"
      - name: is_transactional
        data_type: boolean
        description: "Whether this account supports transactions"
      - name: is_mortgage
        data_type: boolean
        description: "Whether this account is a mortgage account"
      - name: is_asset
        data_type: boolean
        description: "Whether this account is an asset (from seed or heuristic)"
      - name: is_liquid_asset
        data_type: boolean
        description: "Whether this account is a liquid asset (from seed or heuristic)"
      - name: created_at
        data_type: timestamp
        description: "Timestamp when record was created"
      - name: updated_at
        data_type: timestamp
        description: "Timestamp when record was last updated"

  - name: dim_categories_enhanced
    config:
      contract:
        enforced: true
    constraints:
      - type: primary_key
        columns: [category_key]
      - type: check
        expression: "category_type IN ('Income', 'Expense', 'Internal Transfer', 'Financial Services', 'Uncategorized')"
        name: chk_category_type_valid
      - type: check
        expression: "category_priority >= 1"
        name: chk_category_priority_positive
    columns:
      - name: category_key
        data_type: text
        description: "Surrogate key for the category dimension"
      - name: level_1_category
        data_type: text
        description: "Level 1 of category hierarchy"
      - name: level_2_subcategory
        data_type: text
        description: "Level 2 of category hierarchy"
      - name: level_3_store
        data_type: text
        description: "Level 3 of category hierarchy"
      - name: category
        data_type: text
        description: "Original category name"
      - name: subcategory
        data_type: text
        description: "Original subcategory name"
      - name: store
        data_type: text
        description: "Original store name"
      - name: internal_indicator
        data_type: text
        description: "Whether this is an internal or external transaction"
      - name: category_type
        data_type: text
        description: "Type of category (Income, Expense, etc.)"
      - name: is_internal_transfer
        data_type: boolean
        description: "Whether this represents an internal transfer"
      - name: is_income
        data_type: boolean
        description: "Whether this represents income"
      - name: is_financial_service
        data_type: boolean
        description: "Whether this represents a financial service"
      - name: category_priority
        data_type: bigint
        description: "Priority for categorization (lower = higher priority)"
      - name: category_description
        data_type: text
        description: "Description of the category"
      - name: created_at
        data_type: timestamp
        description: "Timestamp when record was created"
      - name: updated_at
        data_type: timestamp
        description: "Timestamp when record was last updated"

  - name: fct_transactions_enhanced
    config:
      contract:
        enforced: true
    constraints:
      - type: primary_key
        columns: [transaction_key]
      - type: foreign_key
        columns: [account_key]
        to: ref('dim_accounts_enhanced')
        to_columns: [account_key]
      - type: foreign_key
        columns: [category_key]
        to: ref('dim_categories_enhanced')
        to_columns: [category_key]
      - type: check
        expression: "transaction_direction IN ('Debit', 'Credit', 'Zero')"
        name: chk_transaction_direction_valid
      - type: check
        expression: "transaction_amount_abs >= 0"
        name: chk_transaction_amount_abs_non_negative
      - type: check
        expression: "transaction_date >= '2000-01-01' AND transaction_date <= CURRENT_DATE + INTERVAL '1 day'"
        name: chk_transaction_date_reasonable
    columns:
      - name: transaction_key
        data_type: text
        description: "Surrogate key for the transaction"
      - name: transaction_natural_key
        data_type: text
        description: "Natural key from source system"
      - name: transaction_date
        data_type: date
        description: "Date of the transaction"
      - name: transaction_year
        data_type: bigint
        description: "Year of the transaction"
      - name: transaction_quarter
        data_type: bigint
        description: "Quarter of the transaction"
      - name: transaction_month
        data_type: bigint
        description: "Month of the transaction"
      - name: transaction_day
        data_type: bigint
        description: "Day of the transaction"
      - name: day_of_week
        data_type: bigint
        description: "Day of week (0=Sunday)"
      - name: account_key
        data_type: text
        description: "Foreign key to account dimension"
      - name: category_key
        data_type: text
        description: "Foreign key to category dimension"
      - name: transaction_amount
        data_type: numeric
        description: "Amount of the transaction"
      - name: account_balance
        data_type: numeric
        description: "Account balance after this transaction"
      - name: transaction_direction
        data_type: text
        description: "Direction of transaction (Debit/Credit/Zero)"
      - name: transaction_amount_abs
        data_type: numeric
        description: "Absolute value of transaction amount"
      - name: is_income_transaction
        data_type: boolean
        description: "Whether this is an income transaction"
      - name: is_internal_transfer
        data_type: boolean
        description: "Whether this is an internal transfer"
      - name: is_financial_service
        data_type: boolean
        description: "Whether this is a financial service transaction"
      - name: transaction_memo
        data_type: text
        description: "Transaction memo/description"
      - name: transaction_type
        data_type: text
        description: "Type of transaction"
      - name: transaction_description
        data_type: text
        description: "Full transaction description"
      - name: receipt
        data_type: text
        description: "Receipt information"
      - name: location
        data_type: text
        description: "Transaction location"
      - name: sender
        data_type: text
        description: "Transaction sender"
      - name: recipient
        data_type: text
        description: "Transaction recipient"
      - name: etl_date
        data_type: text
        description: "ETL processing date"
      - name: etl_time
        data_type: text
        description: "ETL processing time"
      - name: fact_created_at
        data_type: timestamp
        description: "Timestamp when fact record was created"

  - name: fct_daily_balances
    config:
      contract:
        enforced: true
    constraints:
      - type: primary_key
        columns: [balance_key]
      - type: foreign_key
        columns: [account_key]
        to: ref('dim_accounts_enhanced')
        to_columns: [account_key]
    columns:
      - name: balance_key
        data_type: text
        description: "Surrogate key for the daily balance record"
      - name: balance_date
        data_type: date
        description: "Date of the balance snapshot"
      - name: account_key
        data_type: text
        description: "Foreign key to account dimension"
      - name: account_name
        data_type: text
        description: "Name of the account"
      - name: daily_balance
        data_type: numeric
        description: "Account balance at end of day"
      - name: balance_change
        data_type: numeric
        description: "Change in balance from previous day"
      - name: transaction_count
        data_type: bigint
        description: "Number of transactions on this date"
      - name: total_debits
        data_type: numeric
        description: "Total debit amount for the day"
      - name: total_credits
        data_type: numeric
        description: "Total credit amount for the day"
      - name: is_weekend
        data_type: boolean
        description: "Whether this date falls on a weekend"
      - name: is_month_end
        data_type: boolean
        description: "Whether this is the last day of the month"
      - name: created_at
        data_type: timestamp
        description: "Timestamp when record was created"

  - name: rpt_outflows_reconciliation_tests
    description: "Per-period reconciliation checks comparing viz outflows to fact aggregates with pass/fail."
    columns:
      - name: period_date
        data_type: date
        description: "Month (first day) the test applies to"
      - name: test_name
        data_type: text
        description: "Identifier for the reconciliation check"
      - name: left_value
        data_type: numeric
        description: "Value from viz_detailed_outflows_breakdown"
      - name: right_value
        data_type: numeric
        description: "Reference value from fact tables"
      - name: delta
        data_type: numeric
        description: "Difference left - right"
      - name: pass
        data_type: boolean
        description: "True when within tolerance"
      - name: notes
        data_type: text
        description: "Short description of what is compared"
      - name: tested_at
        data_type: timestamp
        description: "Timestamp when the row was evaluated"

  - name: rpt_outflows_reconciliation_summary
    description: "Summary of reconciliation results per period with overall PASS/FAIL flag."
    columns:
      - name: period_date
        data_type: date
        description: "Month (first day) being summarized"
      - name: passed
        data_type: bigint
        description: "Number of passing checks"
      - name: failed
        data_type: bigint
        description: "Number of failing checks"
      - name: total
        data_type: bigint
        description: "Total checks for the period"
      - name: status
        data_type: text
        description: "PASS if no failures, else FAIL"
      - name: is_latest
        data_type: boolean
        description: "True for latest month"
      - name: summarized_at
        data_type: timestamp
        description: "Timestamp when summary was computed"

  - name: viz_uncategorized_missing_example_top5
    description: "Top 5 high-value uncategorized groups (monthly) where no example transaction text is present."
    columns:
      - name: month
        data_type: text
        description: "YYYY-MM month label"
      - name: account_name
        data_type: text
        description: "Account associated with the group"
      - name: amount
        data_type: numeric
        description: "Total absolute outflows for the group"
      - name: count
        data_type: bigint
        description: "Number of transactions in the group"
      - name: example_transaction
        data_type: text
        description: "Example transaction text (expected missing for this view)"
      - name: suggested_category
        data_type: text
        description: "Suggested category based on memo similarity"
      - name: suggested_subcategory
        data_type: text
        description: "Suggested subcategory"
      - name: confidence
        data_type: numeric
        description: "Confidence score for the suggestion"

  - name: rpt_financials_reconciliation_tests
    description: "Cross-dashboard reconciliation checks (budget, cash flow, executive, income/expense, outflows)."
    columns:
      - name: period_date
        data_type: date
      - name: domain
        data_type: text
        description: "Test domain: Outflows, Budget, CashFlow, Executive, IncomeExpense"
      - name: test_name
        data_type: text
      - name: left_value
        data_type: numeric
      - name: right_value
        data_type: numeric
      - name: delta
        data_type: numeric
      - name: pass
        data_type: boolean
      - name: notes
        data_type: text

  - name: rpt_financials_reconciliation_summary
    description: "Summary of reconciliation results across all domains per period."
    columns:
      - name: period_date
        data_type: date
      - name: passed
        data_type: bigint
      - name: failed
        data_type: bigint
      - name: total
        data_type: bigint
      - name: status
        data_type: text

  - name: viz_grocery_spending_analysis
    description: "Monthly grocery spending analysis by store (Coles, Woolworths, Gaskos) with transaction counts and percentages"
    columns:
      - name: year_month
        data_type: timestamp with time zone
        description: "Month of the transactions"
      - name: grocery_store
        data_type: text
        description: "Grocery store name (Coles, Woolworths, Gaskos)"
      - name: monthly_spend
        data_type: numeric
        description: "Total spending for the month at this store (positive)"
      - name: transaction_count
        data_type: bigint
        description: "Number of transactions at this store"
      - name: avg_transaction_size
        data_type: numeric
        description: "Average transaction amount for this store"
      - name: total_monthly_spend
        data_type: numeric
        description: "Total grocery spending across all stores for the month"
      - name: total_transaction_count
        data_type: bigint
        description: "Total transaction count across all stores"
      - name: percentage_of_total
        data_type: numeric
        description: "Store's percentage share of total monthly grocery spending"

  - name: viz_grocery_insights
    description: "Grocery spending insights with growth trends and store rankings"
    columns:
      - name: grocery_store
        data_type: text
        description: "Grocery store name"
      - name: year_month
        data_type: timestamp with time zone
        description: "Month of analysis"
      - name: monthly_spend
        data_type: numeric
        description: "Monthly spending amount"
      - name: same_month_last_year
        data_type: numeric
        description: "Spending for same month in previous year"
      - name: yoy_growth_percent
        data_type: numeric
        description: "Year-over-year growth percentage"
      - name: previous_month_spend
        data_type: numeric
        description: "Previous month's spending"
      - name: mom_growth_percent
        data_type: numeric
        description: "Month-over-month growth percentage"
      - name: spending_rank
        data_type: bigint
        description: "Store ranking by spending for the month"
      - name: store_category
        data_type: text
        description: "Store category (Primary Store, Secondary Store, Other Store)"
      - name: percentage_of_total
        data_type: numeric
        description: "Store's percentage share of total monthly spending"
      - name: yoy_trend_category
        data_type: text
        description: "Year-over-year trend category (High Change, Moderate Change, Stable, No Historical Data)"
      - name: mom_trend_category
        data_type: text
        description: "Month-over-month trend category (High Volatility, Moderate Volatility, Stable, No Previous Month)"

  - name: viz_grocery_monthly_summary
    description: "Monthly grocery spending summary with totals and growth metrics for dashboard"
    columns:
      - name: year_month
        data_type: timestamp with time zone
        description: "Month of the summary"
      - name: coles_spend
        data_type: numeric
        description: "Total spending at Coles for the month"
      - name: woolworths_spend
        data_type: numeric
        description: "Total spending at Woolworths for the month"
      - name: gaskos_spend
        data_type: numeric
        description: "Total spending at Gaskos for the month"
      - name: total_grocery_spend
        data_type: numeric
        description: "Total grocery spending across all stores"
      - name: coles_transactions
        data_type: bigint
        description: "Number of Coles transactions"
      - name: woolworths_transactions
        data_type: bigint
        description: "Number of Woolworths transactions"
      - name: gaskos_transactions
        data_type: bigint
        description: "Number of Gaskos transactions"
      - name: total_transactions
        data_type: bigint
        description: "Total grocery transactions"
      - name: previous_month_total
        data_type: numeric
        description: "Previous month's total grocery spending"
      - name: same_month_last_year_total
        data_type: numeric
        description: "Total grocery spending for same month last year"
      - name: mom_growth_percent
        data_type: numeric
        description: "Month-over-month growth percentage"
      - name: yoy_growth_percent
        data_type: numeric
        description: "Year-over-year growth percentage"
      - name: coles_percentage
        data_type: numeric
        description: "Coles percentage of total monthly spending"
      - name: woolworths_percentage
        data_type: numeric
        description: "Woolworths percentage of total monthly spending"
      - name: gaskos_percentage
        data_type: numeric
        description: "Gaskos percentage of total monthly spending"
      - name: coles_avg_transaction
        data_type: numeric
        description: "Average Coles transaction size"
      - name: woolworths_avg_transaction
        data_type: numeric
        description: "Average Woolworths transaction size"
      - name: gaskos_avg_transaction
        data_type: numeric
        description: "Average Gaskos transaction size"
      - name: total_avg_transaction
        data_type: numeric
        description: "Average transaction size across all stores"
