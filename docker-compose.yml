services:
  dagster_webserver:
    build:
      context: .
      dockerfile: dagster_core/dockerfile
      args:
        - DAGSTER_APP=${DAGSTER_APP}
        - DAGSTER_HOME=${DAGSTER_HOME}
    entrypoint:
      - dagster-webserver
      - --host
      - "0.0.0.0"
      - --port
      - "3000"
      - --workspace
      - "${DAGSTER_HOME}/workspace.yaml"
    expose:
      - "3000"
    # Host port binding lives in docker-compose.local.yml to avoid conflicts on dev machines.
    environment:
      DAGSTER_POSTGRES_HOST: ${DAGSTER_POSTGRES_HOST}
      DAGSTER_POSTGRES_USER: ${DAGSTER_POSTGRES_USER}
      DAGSTER_POSTGRES_PASSWORD: ${DAGSTER_POSTGRES_PASSWORD}
      DAGSTER_POSTGRES_PORT: ${DAGSTER_POSTGRES_PORT}
      DAGSTER_POSTGRES_DB: ${DAGSTER_POSTGRES_DB}
      DBT_EXECUTION_CONTEXT: dagster
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/io_manager_storage:/tmp/io_manager_storage
    networks:
      - dagster_network
    depends_on:
      dagster_postgres:
        condition: service_healthy
      pipeline_personal_finance:
        condition: service_started
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    env_file:
      - .env

  dagster_daemon:
    build:
      context: .
      dockerfile: dagster_core/dockerfile
      args:
        DAGSTER_APP: ${DAGSTER_APP}
        DAGSTER_HOME: ${DAGSTER_HOME}
    entrypoint:
      - dagster-daemon
      - run
      - --workspace
      - "${DAGSTER_HOME}/workspace.yaml"
    # expose:
    #   - "4000"
    # ports:
    #   - "4000:4000"
    restart: on-failure
    environment:
      DAGSTER_POSTGRES_HOST: ${DAGSTER_POSTGRES_HOST}
      DAGSTER_POSTGRES_USER: ${DAGSTER_POSTGRES_USER}
      DAGSTER_POSTGRES_PASSWORD: ${DAGSTER_POSTGRES_PASSWORD}
      DAGSTER_POSTGRES_PORT: ${DAGSTER_POSTGRES_PORT}
      DAGSTER_POSTGRES_DB: ${DAGSTER_POSTGRES_DB}
      DAGSTER_HOME: ${DAGSTER_HOME}
      DAGSTER_APP: ${DAGSTER_APP}
      DBT_EXECUTION_CONTEXT: dagster
    # no use on windows.
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/io_manager_storage:${DAGSTER_HOME}/io_manager_storage
    networks:
      - dagster_network
    depends_on:
      dagster_postgres:
        condition: service_healthy
      pipeline_personal_finance:
        condition: service_started
    env_file:
      - .env

  pipeline_personal_finance:
    build:
      context: .
      dockerfile: pipeline_personal_finance/dockerfile
      args:
        - DAGSTER_APP=${DAGSTER_APP}
    image: pipeline_personal_finance
    command: ["dagster", "api", "grpc", "-h", "0.0.0.0", "-p", "4000", "-m", "pipeline_personal_finance"]
    expose:
      - "4000"
    environment:
      TIMEZONE: Australia/Melbourne
      DAGSTER_CURRENT_IMAGE: pipeline_personal_finance
      DAGSTER_POSTGRES_HOST: ${DAGSTER_POSTGRES_HOST}
      DAGSTER_POSTGRES_USER: ${DAGSTER_POSTGRES_USER}
      DAGSTER_POSTGRES_PASSWORD: ${DAGSTER_POSTGRES_PASSWORD}
      DAGSTER_POSTGRES_PORT: ${DAGSTER_POSTGRES_PORT}
      DAGSTER_POSTGRES_DB: ${DAGSTER_POSTGRES_DB}
      DBT_PROJECT_DIR: ${DBT_PROJECT_DIR}
      DBT_PROFILES_DIR: ${DBT_PROJECT_DIR}
      DAGSTER_DEPLOYMENT: ${DAGSTER_DEPLOYMENT}
      # Dashboard QA â€” use the internal Docker service URL, not the host-external one
      GRAFANA_URL: http://grafana:3000
      # Optional: API token auth for Grafana. If unset, GRAFANA_USER + GRAFANA_ADMIN_PASSWORD are used instead.
      GRAFANA_TOKEN: ${GRAFANA_TOKEN}
      GRAFANA_USER: ${GRAFANA_USER}
      GRAFANA_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      POSTGRES_ADMIN_USER: ${POSTGRES_ADMIN_USER}
      POSTGRES_ADMIN_PASSWORD: ${POSTGRES_ADMIN_PASSWORD}
      DASHBOARD_DIR: /opt/dagster/app/grafana/provisioning/dashboards
      DBT_EXECUTION_CONTEXT: dagster
    volumes:
      - /tmp/dagster-data:/tmp/dagster-data
      - ./pipeline_personal_finance/qif_files:/opt/dagster/app/pipeline_personal_finance/qif_files
      - ./grafana/provisioning/dashboards:/opt/dagster/app/grafana/provisioning/dashboards:ro
    networks:
      - dagster_network
    # ports:
    #   - "5678:5678"
    env_file:
      - .env
    depends_on:
      dagster_postgres:
        condition: service_healthy
    # This looks to enable code-server, which is how you can get docker to look for updates.
    # entrypoint: python
    # command:
    #   - -m
    #   - debugpy
    #   - --listen
    #   - 0.0.0.0:5678
    #   - -m
    #   - dagster
    #   - code-server
    #   - start
    #   - -h
    #   - 0.0.0.0
    #   - -p
    #   - "4000"
    #   - -m
    #   - defs

  dagster_postgres:
    build:
      context: ./postgres
      dockerfile: dockerfile
    shm_size: 128mb
    restart: on-failure
    environment:
      POSTGRES_USER: ${POSTGRES_ADMIN_USER}
      POSTGRES_PASSWORD: ${POSTGRES_ADMIN_PASSWORD}
      POSTGRES_DB: ${DAGSTER_POSTGRES_DB}
      DAGSTER_POSTGRES_USER: ${DAGSTER_POSTGRES_USER}
      DAGSTER_POSTGRES_PASSWORD: ${DAGSTER_POSTGRES_PASSWORD}
      GRAFANA_USER: ${GRAFANA_USER}
      GRAFANA_PASSWORD: ${GRAFANA_PASSWORD}
      PGDATA: /var/lib/postgresql/data/personal_finance/
    # Host port is not needed for container-to-container comms.
    # Add to docker-compose.local.yml if you need direct host access.
    volumes:
      - postgres-data:/var/lib/postgresql/data/
    networks:
      - dagster_network
    env_file:
      - .env
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_ADMIN_USER} -d ${DAGSTER_POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s

  grafana:
    image: grafana/grafana:latest
    restart: unless-stopped
    ports:
      - "0.0.0.0:3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GRAFANA_PASSWORD=${GRAFANA_PASSWORD}
      - GF_PLUGINS_PREINSTALL=motherduck-duckdb-datasource@https://github.com/motherduckdb/grafana-duckdb-datasource/releases/download/v0.4.0/motherduck-duckdb-datasource-0.4.0.zip
    volumes:
      - grafana-storage:/var/lib/grafana
      - ./pipeline_personal_finance/dbt_finance/duckdb:/var/lib/grafana/duckdb
      - ./grafana/provisioning:/etc/grafana/provisioning
    networks:
      - dagster_network
    depends_on:
      dagster_postgres:
        condition: service_healthy
    env_file:
      - .env

volumes:
  grafana-storage:
  postgres-data:

networks:
  dagster_network:
    name: qif_personal_finance_dagster_network
    driver: bridge
