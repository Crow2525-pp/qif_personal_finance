{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "links": [
    {
      "icon": "external link",
      "includeVars": false,
      "keepTime": true,
      "targetBlank": false,
      "title": "View in 01 - Executive Financial Overview",
      "type": "link",
      "url": "/d/executive_dashboard?orgId=1&${__url_time_range}&var-time_window=${time_window}"
    },
    {
      "icon": "external link",
      "includeVars": false,
      "keepTime": true,
      "targetBlank": false,
      "title": "View in 06 - Category Spending Analysis",
      "type": "link",
      "url": "/d/category-spending-v2?orgId=1&${__url_time_range}"
    },
    {
      "icon": "external link",
      "includeVars": false,
      "keepTime": true,
      "targetBlank": false,
      "title": "View in 08 - Outflows Insights",
      "type": "link",
      "url": "/d/outflows_insights?orgId=1&${__url_time_range}"
    },
    {
      "icon": "external link",
      "includeVars": false,
      "keepTime": true,
      "targetBlank": false,
      "title": "View in 10 - Financial Reconciliation",
      "type": "link",
      "url": "/d/outflows_reconciliation?orgId=1&${__url_time_range}&var-time_window=${time_window}"
    }
  ],
  "liveNow": false,
  "panels": [
    {
      "datasource": {
        "type": "text",
        "uid": "-- Text --"
      },
      "gridPos": {
        "h": 5,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 100,
      "options": {
        "content": "# ðŸ“‹ Transaction Analysis Dashboard\n\n**Purpose**: Identify spending patterns, recurring merchants, and transactions that need categorisation.\n\n**Workflow**\n1. Check the KPI row to understand overall activity for the last 12 closed months.\n2. Use the inflow/outflow trend to confirm monthly cash movement.\n3. Review top spending categories and drill into large uncategorised items.\n4. Inspect recurring merchants for unexpected subscriptions or fees.\n5. Use the account summary to see where activity concentrates.\n\n_All panels exclude internal transfers and the current, incomplete month._",
        "mode": "markdown"
      },
      "pluginVersion": "10.0.0",
      "title": "Dashboard Instructions",
      "type": "text"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "PCC52D03280B7034C"
      },
      "gridPos": {
        "h": 5,
        "w": 24,
        "x": 0,
        "y": 5
      },
      "id": 1,
      "title": "Transactions Overview (Last 12 Closed Months)",
      "type": "stat",
      "pluginVersion": "10.0.0",
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": true
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "fieldConfig": {
        "defaults": {
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "total_transactions"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Transactions"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "total_inflow"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Total Inflow"
              },
              {
                "id": "unit",
                "value": "currencyUSD"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "total_outflow"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Total Outflow"
              },
              {
                "id": "unit",
                "value": "currencyUSD"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "net_amount"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Net Amount"
              },
              {
                "id": "unit",
                "value": "currencyUSD"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "avg_transaction"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Avg Transaction"
              },
              {
                "id": "unit",
                "value": "currencyUSD"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "distinct_merchants"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Distinct Descriptions"
              }
            ]
          }
        ]
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "PCC52D03280B7034C"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\n  COUNT(*) AS total_transactions,\n  SUM(CASE WHEN transaction_amount > 0 THEN transaction_amount ELSE 0 END) AS total_inflow,\n  SUM(CASE WHEN transaction_amount < 0 THEN -transaction_amount ELSE 0 END) AS total_outflow,\n  SUM(transaction_amount) AS net_amount,\n  AVG(ABS(transaction_amount)) AS avg_transaction,\n  COUNT(DISTINCT COALESCE(NULLIF(transaction_memo, ''), transaction_description)) AS distinct_merchants\nFROM reporting.fct_transactions_enhanced\nWHERE transaction_date >= date_trunc('month', CURRENT_DATE) - INTERVAL '12 months'\n  AND transaction_date < date_trunc('month', CURRENT_DATE)\n  AND NOT COALESCE(is_internal_transfer, FALSE);",
          "refId": "A"
        }
      ]
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "PCC52D03280B7034C"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 10
      },
      "id": 2,
      "title": "Monthly Inflows vs Outflows",
      "type": "timeseries",
      "pluginVersion": "10.0.0",
      "options": {
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "drawStyle": "line",
            "fillOpacity": 15,
            "lineWidth": 2,
            "showPoints": "never",
            "stacking": {
              "mode": "none"
            }
          },
          "unit": "currencyUSD"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "inflow"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Inflow"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#2f87d0",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "outflow"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Outflow"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#d64e4e",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "net"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Net"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "#6ac36a",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "PCC52D03280B7034C"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\n  date_trunc('month', transaction_date) AS time,\n  SUM(CASE WHEN transaction_amount > 0 THEN transaction_amount ELSE 0 END) AS inflow,\n  SUM(CASE WHEN transaction_amount < 0 THEN -transaction_amount ELSE 0 END) AS outflow,\n  SUM(transaction_amount) AS net\nFROM reporting.fct_transactions_enhanced\nWHERE transaction_date >= date_trunc('month', CURRENT_DATE) - INTERVAL '12 months'\n  AND transaction_date < date_trunc('month', CURRENT_DATE)\n  AND NOT COALESCE(is_internal_transfer, FALSE)\nGROUP BY 1\nORDER BY 1;",
          "refId": "A"
        }
      ]
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "PCC52D03280B7034C"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 10
      },
      "id": 3,
      "title": "Top Spending Categories",
      "type": "table",
      "pluginVersion": "10.0.0",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            }
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "txn_count"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Transactions"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "total_amount"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Total"
              },
              {
                "id": "unit",
                "value": "currencyUSD"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "avg_amount"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Average"
              },
              {
                "id": "unit",
                "value": "currencyUSD"
              }
            ]
          }
        ]
      },
      "options": {
        "cellHeight": "sm",
        "showHeader": true
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "PCC52D03280B7034C"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\n  COALESCE(NULLIF(dc.level_1_category, 'Uncategorized'), 'Uncategorised') AS category,\n  COUNT(*) FILTER (WHERE ft.transaction_amount < 0) AS txn_count,\n  SUM(CASE WHEN ft.transaction_amount < 0 THEN -ft.transaction_amount ELSE 0 END) AS total_amount,\n  AVG(CASE WHEN ft.transaction_amount < 0 THEN -ft.transaction_amount END) AS avg_amount\nFROM reporting.fct_transactions_enhanced ft\nLEFT JOIN reporting.dim_categories_enhanced dc ON ft.category_key = dc.category_key\nWHERE ft.transaction_date >= date_trunc('month', CURRENT_DATE) - INTERVAL '12 months'\n  AND ft.transaction_date < date_trunc('month', CURRENT_DATE)\n  AND NOT COALESCE(ft.is_internal_transfer, FALSE)\nGROUP BY 1\nHAVING SUM(CASE WHEN ft.transaction_amount < 0 THEN -ft.transaction_amount ELSE 0 END) > 0\nORDER BY total_amount DESC\nLIMIT 12;",
          "refId": "A"
        }
      ]
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "PCC52D03280B7034C"
      },
      "gridPos": {
        "h": 10,
        "w": 12,
        "x": 0,
        "y": 18
      },
      "id": 4,
      "title": "High Value Needs Review",
      "type": "table",
      "pluginVersion": "10.0.0",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            }
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "amount"
            },
            "properties": [
              {
                "id": "unit",
                "value": "currencyUSD"
              },
              {
                "id": "displayName",
                "value": "Amount"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "transaction_date"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Date"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "account_name"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Account"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "level_1_category"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Category"
              }
            ]
          }
        ]
      },
      "options": {
        "cellHeight": "sm",
        "showHeader": true
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "PCC52D03280B7034C"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\n  ft.transaction_date::date,\n  da.account_name,\n  -ft.transaction_amount AS amount,\n  COALESCE(NULLIF(dc.level_1_category, 'Uncategorized'), 'Uncategorised') AS level_1_category,\n  ft.transaction_description,\n  ft.transaction_memo\nFROM reporting.fct_transactions_enhanced ft\nLEFT JOIN reporting.dim_categories_enhanced dc ON ft.category_key = dc.category_key\nLEFT JOIN reporting.dim_accounts_enhanced da ON ft.account_key = da.account_key\nWHERE ft.transaction_date >= date_trunc('month', CURRENT_DATE) - INTERVAL '12 months'\n  AND ft.transaction_date < date_trunc('month', CURRENT_DATE)\n  AND ft.transaction_amount < 0\n  AND NOT COALESCE(ft.is_internal_transfer, FALSE)\nORDER BY -ft.transaction_amount DESC\nLIMIT 25;",
          "refId": "A"
        }
      ]
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "PCC52D03280B7034C"
      },
      "gridPos": {
        "h": 10,
        "w": 12,
        "x": 12,
        "y": 18
      },
      "id": 5,
      "title": "Recurring Merchants (6 Months)",
      "type": "table",
      "pluginVersion": "10.0.0",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            }
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "total_amount"
            },
            "properties": [
              {
                "id": "unit",
                "value": "currencyUSD"
              },
              {
                "id": "displayName",
                "value": "Total"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "txn_count"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Transactions"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "first_seen"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "First Seen"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "last_seen"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Last Seen"
              }
            ]
          }
        ]
      },
      "options": {
        "cellHeight": "sm",
        "showHeader": true
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "PCC52D03280B7034C"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\n  COALESCE(NULLIF(transaction_memo, ''), transaction_description) AS merchant,\n  COUNT(*) AS txn_count,\n  SUM(CASE WHEN transaction_amount < 0 THEN -transaction_amount ELSE 0 END) AS total_amount,\n  MIN(transaction_date)::date AS first_seen,\n  MAX(transaction_date)::date AS last_seen\nFROM reporting.fct_transactions_enhanced\nWHERE transaction_date >= date_trunc('month', CURRENT_DATE) - INTERVAL '6 months'\n  AND transaction_date < date_trunc('month', CURRENT_DATE)\n  AND transaction_amount < 0\n  AND NOT COALESCE(is_internal_transfer, FALSE)\nGROUP BY 1\nHAVING COUNT(*) >= 5\nORDER BY MAX(transaction_date) DESC\nLIMIT 25;",
          "refId": "A"
        }
      ]
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "PCC52D03280B7034C"
      },
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 28
      },
      "id": 6,
      "title": "Transactions by Account",
      "type": "table",
      "pluginVersion": "10.0.0",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            }
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "txn_count"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Transactions"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "total_amount"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Total Movement"
              },
              {
                "id": "unit",
                "value": "currencyUSD"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "net_amount"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Net"
              },
              {
                "id": "unit",
                "value": "currencyUSD"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "average_amount"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Average"
              },
              {
                "id": "unit",
                "value": "currencyUSD"
              }
            ]
          }
        ]
      },
      "options": {
        "cellHeight": "sm",
        "showHeader": true
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "PCC52D03280B7034C"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\n  da.account_name,\n  COUNT(*) AS txn_count,\n  SUM(ABS(ft.transaction_amount)) AS total_amount,\n  SUM(ft.transaction_amount) AS net_amount,\n  AVG(ABS(ft.transaction_amount)) AS average_amount\nFROM reporting.fct_transactions_enhanced ft\nLEFT JOIN reporting.dim_accounts_enhanced da ON ft.account_key = da.account_key\nWHERE ft.transaction_date >= date_trunc('month', CURRENT_DATE) - INTERVAL '12 months'\n  AND ft.transaction_date < date_trunc('month', CURRENT_DATE)\n  AND NOT COALESCE(ft.is_internal_transfer, FALSE)\nGROUP BY da.account_name\nORDER BY SUM(ABS(ft.transaction_amount)) DESC;",
          "refId": "A"
        }
      ]
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "PCC52D03280B7034C"
      },
      "description": "Quick view of data-quality blockers for the latest complete month.",
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "left"
          },
          "links": [
            {
              "title": "View Outflows Reconciliation Exceptions",
              "url": "/d/outflows_reconciliation?orgId=1&${__url_time_range}",
              "targetBlank": true
            }
          ]
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "value"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 140
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "detail"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 240
              }
            ]
          }
        ]
      },
      "gridPos": {
        "x": 0,
        "y": 36,
        "w": 12,
        "h": 6
      },
      "id": 907,
      "options": {
        "cellHeight": "sm",
        "showHeader": true
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "PCC52D03280B7034C"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "WITH available_months AS (\n  SELECT budget_year_month,\n         to_date(budget_year_month || '-01', 'YYYY-MM-DD') AS month_date\n  FROM reporting.rpt_monthly_budget_summary\n  WHERE budget_year_month < TO_CHAR(CURRENT_DATE, 'YYYY-MM')\n),\nlatest_period AS (\n  SELECT MAX(month_date) AS month_date\n  FROM available_months\n),\nperiod_bounds AS (\n  SELECT month_date,\n         month_date AS month_start,\n         (month_date + INTERVAL '1 month' - INTERVAL '1 day')::date AS month_end\n  FROM latest_period\n),\nstale_accounts AS (\n  SELECT COUNT(*) AS stale_accounts\n  FROM reporting.dim_accounts_enhanced\n  WHERE account_last_transaction_date < (SELECT month_end FROM period_bounds) - INTERVAL '45 days'\n),\ntransfer_pairs AS (\n  SELECT\n    transaction_date::date AS txn_date,\n    transaction_amount_abs AS amount_abs,\n    SUM(CASE WHEN transaction_amount < 0 THEN 1 ELSE 0 END) AS out_count,\n    SUM(CASE WHEN transaction_amount > 0 THEN 1 ELSE 0 END) AS in_count\n  FROM reporting.fct_transactions_enhanced\n  WHERE COALESCE(is_internal_transfer, FALSE)\n    AND transaction_date >= (SELECT month_start FROM period_bounds)\n    AND transaction_date <= (SELECT month_end FROM period_bounds)\n  GROUP BY 1,2\n),\nunmatched_transfers AS (\n  SELECT COALESCE(SUM(ABS(out_count - in_count)), 0) AS unmatched_count\n  FROM transfer_pairs\n),\nuncategorized AS (\n  SELECT uncategorized_pct\n  FROM reporting.rpt_outflows_insights_dashboard\n  WHERE period_date = (SELECT month_date FROM period_bounds)\n)\nSELECT 'Stale accounts (45d+ no activity)' AS metric,\n       COALESCE((SELECT stale_accounts FROM stale_accounts), 0)::text AS value,\n       'Accounts without recent transactions' AS detail\nUNION ALL\nSELECT 'Unmatched internal transfers',\n       COALESCE((SELECT unmatched_count FROM unmatched_transfers), 0)::text,\n       'Proxy count based on paired in/out amounts'\nUNION ALL\nSELECT 'Uncategorized spend %',\n       CONCAT(ROUND(COALESCE((SELECT uncategorized_pct FROM uncategorized), 0), 1), '%'),\n       'Share of outflows currently uncategorized';",
          "refId": "A"
        }
      ],
      "title": "Data Quality Callouts",
      "type": "table"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "PCC52D03280B7034C"
      },
      "description": "Top uncategorized merchants (latest complete month).",
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "left"
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Total Spend"
            },
            "properties": [
              {
                "id": "unit",
                "value": "currencyUSD"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "Last Seen"
            },
            "properties": [
              {
                "id": "unit",
                "value": "time: YYYY-MM-DD"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "x": 12,
        "y": 36,
        "w": 12,
        "h": 6
      },
      "id": 908,
      "options": {
        "cellHeight": "sm",
        "showHeader": true
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "PCC52D03280B7034C"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "WITH uncategorized AS (\n  SELECT\n    COALESCE(NULLIF(TRIM(ft.transaction_memo), ''), NULLIF(TRIM(ft.transaction_description), '')) AS original_memo,\n    COUNT(*) AS transaction_count,\n    SUM(ABS(ft.transaction_amount)) AS total_amount,\n    MAX(ft.transaction_date) AS last_transaction_date\n  FROM reporting.fct_transactions ft\n  LEFT JOIN reporting.dim_categories dc ON ft.category_key = dc.category_key\n  WHERE dc.level_1_category = 'Uncategorized'\n    AND ft.transaction_amount < 0\n    AND NOT COALESCE(ft.is_internal_transfer, FALSE)\n    AND COALESCE(NULLIF(TRIM(ft.transaction_memo), ''), NULLIF(TRIM(ft.transaction_description), '')) IS NOT NULL\n  GROUP BY COALESCE(NULLIF(TRIM(ft.transaction_memo), ''), NULLIF(TRIM(ft.transaction_description), ''))\n  HAVING COUNT(*) >= 2 OR SUM(ABS(ft.transaction_amount)) >= 100\n),\ndata AS (\n  SELECT\n    original_memo,\n    transaction_count,\n    ROUND(total_amount, 2) AS total_spend,\n    last_transaction_date,\n    CASE\n      WHEN total_amount >= 1000 THEN 'HIGH'\n      WHEN total_amount >= 500 THEN 'MEDIUM'\n      WHEN total_amount >= 100 THEN 'LOW'\n      ELSE 'MINOR'\n    END AS priority_level\n  FROM uncategorized\n  ORDER BY total_amount DESC\n  LIMIT 10\n)\nSELECT\n  original_memo AS \"Merchant\",\n  transaction_count AS \"Txn Count\",\n  total_spend AS \"Total Spend\",\n  last_transaction_date AS \"Last Seen\",\n  priority_level AS \"Priority\"\nFROM data\nUNION ALL\nSELECT 'None', 0, 0, NULL::date, 'N/A'\nWHERE NOT EXISTS (SELECT 1 FROM data)",
          "refId": "A"
        }
      ],
      "title": "Top Uncategorized Merchants",
      "type": "table"
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "PCC52D03280B7034C"
      },
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 42
      },
      "id": 7,
      "title": "Transaction Anomalies (Baseline Comparison)",
      "type": "table",
      "pluginVersion": "10.0.0",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            }
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "amount_abs"
            },
            "properties": [
              {
                "id": "unit",
                "value": "currencyUSD"
              },
              {
                "id": "displayName",
                "value": "Amount"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "merchant_12m_avg"
            },
            "properties": [
              {
                "id": "unit",
                "value": "currencyUSD"
              },
              {
                "id": "displayName",
                "value": "12m Avg"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "variance_from_avg_pct"
            },
            "properties": [
              {
                "id": "unit",
                "value": "percent"
              },
              {
                "id": "displayName",
                "value": "Variance %"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "transaction_date"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Date"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "anomaly_severity_label"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Severity"
              }
            ]
          }
        ]
      },
      "options": {
        "cellHeight": "sm",
        "showHeader": true
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "PCC52D03280B7034C"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "WITH merchant_baseline AS (\n  SELECT\n    COALESCE(NULLIF(TRIM(ft.transaction_memo), ''), NULLIF(TRIM(ft.transaction_description), ''), 'Unknown') AS merchant_name,\n    COUNT(*) AS merchant_12m_count,\n    AVG(ft.transaction_amount_abs) AS merchant_12m_avg\n  FROM reporting.fct_transactions ft\n  WHERE ft.transaction_date >= CURRENT_DATE - INTERVAL '12 months'\n    AND ft.transaction_amount < 0\n    AND NOT COALESCE(ft.is_internal_transfer, FALSE)\n  GROUP BY COALESCE(NULLIF(TRIM(ft.transaction_memo), ''), NULLIF(TRIM(ft.transaction_description), ''), 'Unknown')\n  HAVING COUNT(*) >= 2\n),\nrecent_txns AS (\n  SELECT\n    ft.transaction_date,\n    da.account_name,\n    COALESCE(NULLIF(TRIM(ft.transaction_memo), ''), NULLIF(TRIM(ft.transaction_description), ''), 'Unknown') AS merchant_name,\n    dc.level_1_category AS category_name,\n    ft.transaction_amount_abs AS amount_abs\n  FROM reporting.fct_transactions ft\n  LEFT JOIN reporting.dim_accounts da ON ft.account_key = da.account_key\n  LEFT JOIN reporting.dim_categories dc ON ft.category_key = dc.category_key\n  WHERE ft.transaction_date >= CURRENT_DATE - INTERVAL '3 months'\n    AND ft.transaction_amount < 0\n    AND NOT COALESCE(ft.is_internal_transfer, FALSE)\n)\nSELECT\n  rt.transaction_date::date,\n  rt.account_name,\n  rt.merchant_name,\n  rt.category_name,\n  rt.amount_abs,\n  ROUND(mb.merchant_12m_avg::numeric, 2) AS merchant_12m_avg,\n  ROUND(((rt.amount_abs - mb.merchant_12m_avg) / NULLIF(mb.merchant_12m_avg, 0) * 100)::numeric, 1) AS variance_from_avg_pct,\n  mb.merchant_12m_count,\n  CASE\n    WHEN rt.amount_abs > mb.merchant_12m_avg * 2 THEN 'HIGH'\n    WHEN rt.amount_abs > mb.merchant_12m_avg * 1.5 THEN 'MEDIUM'\n    ELSE 'LOW'\n  END AS anomaly_severity_label\nFROM recent_txns rt\nJOIN merchant_baseline mb ON rt.merchant_name = mb.merchant_name\nWHERE rt.amount_abs > mb.merchant_12m_avg * 1.3\nORDER BY variance_from_avg_pct DESC\nLIMIT 30",
          "refId": "A"
        }
      ]
    },
    {
      "datasource": {
        "type": "postgres",
        "uid": "PCC52D03280B7034C"
      },
      "gridPos": {
        "h": 10,
        "w": 24,
        "x": 0,
        "y": 52
      },
      "id": 8,
      "title": "Transactions Needing Review",
      "type": "table",
      "pluginVersion": "10.0.0",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            }
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "amount_abs"
            },
            "properties": [
              {
                "id": "unit",
                "value": "currencyUSD"
              },
              {
                "id": "displayName",
                "value": "Amount"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "transaction_date"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Date"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "primary_review_reason"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Review Reason"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "priority_label"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Priority"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "level_1_category"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Category"
              }
            ]
          }
        ]
      },
      "options": {
        "cellHeight": "sm",
        "showHeader": true
      },
      "targets": [
        {
          "datasource": {
            "type": "postgres",
            "uid": "PCC52D03280B7034C"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "WITH merchant_counts AS (\n  SELECT\n    COALESCE(NULLIF(TRIM(ft.transaction_memo), ''), NULLIF(TRIM(ft.transaction_description), ''), 'Unknown') AS merchant_name,\n    COUNT(*) AS merchant_12m_transaction_count\n  FROM reporting.fct_transactions ft\n  WHERE ft.transaction_date >= CURRENT_DATE - INTERVAL '12 months'\n    AND ft.transaction_amount < 0\n    AND NOT COALESCE(ft.is_internal_transfer, FALSE)\n  GROUP BY COALESCE(NULLIF(TRIM(ft.transaction_memo), ''), NULLIF(TRIM(ft.transaction_description), ''), 'Unknown')\n)\nSELECT\n  ft.transaction_date::date,\n  da.account_name,\n  COALESCE(NULLIF(TRIM(ft.transaction_memo), ''), NULLIF(TRIM(ft.transaction_description), ''), 'Unknown') AS merchant_name,\n  ft.transaction_amount_abs AS amount_abs,\n  dc.level_1_category,\n  CASE\n    WHEN dc.level_1_category = 'Uncategorized' THEN 'Uncategorized transaction'\n    WHEN COALESCE(mc.merchant_12m_transaction_count, 0) <= 1 THEN 'New merchant'\n    WHEN ft.transaction_amount_abs >= 500 THEN 'High value transaction'\n    ELSE 'Review recommended'\n  END AS primary_review_reason,\n  CASE WHEN COALESCE(mc.merchant_12m_transaction_count, 0) <= 1 THEN TRUE ELSE FALSE END AS is_new_merchant,\n  COALESCE(mc.merchant_12m_transaction_count, 0) AS merchant_12m_transaction_count,\n  CASE\n    WHEN ft.transaction_amount_abs >= 1000 THEN 'HIGH'\n    WHEN ft.transaction_amount_abs >= 200 THEN 'MEDIUM'\n    ELSE 'LOW'\n  END AS priority_label,\n  CASE\n    WHEN ft.transaction_date >= DATE_TRUNC('month', CURRENT_DATE) THEN 'CURRENT_MONTH'\n    ELSE 'RECENT'\n  END AS queue_status\nFROM reporting.fct_transactions ft\nLEFT JOIN reporting.dim_accounts da ON ft.account_key = da.account_key\nLEFT JOIN reporting.dim_categories dc ON ft.category_key = dc.category_key\nLEFT JOIN merchant_counts mc\n  ON COALESCE(NULLIF(TRIM(ft.transaction_memo), ''), NULLIF(TRIM(ft.transaction_description), ''), 'Unknown') = mc.merchant_name\nWHERE ft.transaction_date >= CURRENT_DATE - INTERVAL '3 months'\n  AND ft.transaction_amount < 0\n  AND NOT COALESCE(ft.is_internal_transfer, FALSE)\n  AND (\n    dc.level_1_category = 'Uncategorized'\n    OR COALESCE(mc.merchant_12m_transaction_count, 0) <= 1\n    OR ft.transaction_amount_abs >= 500\n  )\nORDER BY\n  CASE WHEN ft.transaction_amount_abs >= 1000 THEN 1 WHEN ft.transaction_amount_abs >= 200 THEN 2 ELSE 3 END ASC,\n  ft.transaction_amount_abs DESC\nLIMIT 40",
          "refId": "A"
        }
      ]
    }
  ],
  "refresh": "",
  "schemaVersion": 39,
  "style": "dark",
  "tags": [
    "transactions",
    "analysis",
    "personal-finance"
  ],
  "templating": {
    "list": [
      {
        "name": "time_window",
        "label": "Time Window",
        "type": "custom",
        "hide": 0,
        "current": {
          "text": "Latest Month",
          "value": "latest_month",
          "selected": true
        },
        "options": [
          {
            "text": "Latest Month",
            "value": "latest_month",
            "selected": true
          },
          {
            "text": "Year to Date",
            "value": "ytd",
            "selected": false
          },
          {
            "text": "Trailing 12 Months",
            "value": "trailing_12m",
            "selected": false
          }
        ],
        "query": "latest_month,ytd,trailing_12m",
        "includeAll": false,
        "multi": false,
        "skipUrlSync": false
      }
    ]
  },
  "time": {
    "from": "now-1y",
    "to": "now"
  },
  "timepicker": {},
  "timezone": "",
  "title": "Transaction Analysis",
  "uid": "transaction_analysis_dashboard",
  "version": 1,
  "weekStart": ""
}
