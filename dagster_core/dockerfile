# ./dockerfile

FROM python:3.11-slim

# RUN rm /var/lib/postgresql/data
ARG DAGSTER_HOME=/docker/appdata/dagster/dagster_home
ARG DAGSTER_APP=/docker/appdata/dagster

ENV DAGSTER_HOME=${DAGSTER_HOME:-homenotset}
ENV DAGSTER_APP=${DAGSTER_APP:-appnotset}
# Test environment variable passing
docker-compose config

# Run with explicit environment variable
docker-compose run --rm -e DAGSTER_HOME=/docker/appdata/dagster/dagster_home pipeline_personal_finance env | findstr DAGSTER

# Debug environment in container
docker-compose run --rm --entrypoint=/bin/bash pipeline_personal_finance -c "echo DAGSTER_HOME=$DAGSTER_HOME"
WORKDIR ${DAGSTER_APP}

# Create application directory
RUN mkdir -p ${DAGSTER_HOME}/

# Create Dagster home directory
COPY pyproject.toml ./
COPY workspace.yaml dagster.yaml  ${DAGSTER_HOME}/

# Install the required dependencies
RUN pip install poetry
RUN poetry config virtualenvs.create false
RUN poetry install --only main


# Verify setup
RUN echo "Verifying paths:" && \
    echo "DAGSTER_HOME=${DAGSTER_HOME}" && \
    echo "DAGSTER_APP=${DAGSTER_APP}" && \
    ls -la ${DAGSTER_HOME}